---
title: "Bismarck Replication Project"
output: github_document
---
# Install Packages and Load them
```{r}
#install.packages("haven")
library(haven)
#install.packages("stargazer")
library(stargazer)
#install.packages("labelled")
library(labelled)
#install.packages("plm")
library(plm)
#install.packages("fastDummies") 
library(fastDummies)
```


# Read the Dataset
```{r}
rm(list = ls())

WD_file = dirname(rstudioapi::getSourceEditorContext()$path)
setwd(WD_file)
getwd()
````


```{r}
data_BHI <- haven::read_dta('BDH-Bismarck-JEEA-spec1.dta')
````

Get Variabel Labels
```{r}
var_label(data_BHI)

val_labels(data_BHI)
````

# Explore the Data
```{r}
head(data_BHI)
````

```{r}
summary(data_BHI)
````

```{r}
str(data_BHI$industry)
```

# Check Panel Structure with plm package
Result: Unbalanced Panel: n = 36, T = 336-336, N = 12096
```{r}
pdim(data_BHI)
````




## S3 method for class 'pdata.frame', index.plm Extract the indexes of panel data
```{r}
#index(data, which = NULL)
# First, create a pdata.frame
#data("data_BHI", package = "plm")
data_panel <- pdata.frame(data_BHI, index=c("id_occ", "id_year"))
#pdata.frame( # all function parameters
  x,
  index = NULL,
  drop.index = FALSE,
  row.names = TRUE,
  stringsAsFactors = FALSE,
  replace.non.finite = FALSE,
  drop.NA.series = FALSE,
  drop.const.series = FALSE,
  drop.unused.levels = FALSE
)

```
# First try DiD

## Create dichotomous BlueCollar variable
```{r}
data$BlueCollar <- ifelse(data$industry == 1, 1, 0)
```
Check if BlueCollar variable is correct
```{r}
"BlueCollar" %in% names(data)  # Should return TRUE
is.numeric(data$BlueCollar)  # Should return TRUE
````

## Create Year Dummies ###### I do not use them atm
Year Dummies and then interaction with blue collar variabel 
```{r}
# i need to convert year to factor for the following list later 
data$year <- as.factor(data$year)

#now year dummies
data <- fastDummies::dummy_cols(data, select_columns = "year", remove_selected_columns = FALSE)

# List of year dummy columns
year_dummies <- grep("year_", names(data), value = TRUE)

# show year_dummies variable
year_dummies

# Check if all year dummies exist in the data
sapply(year_dummies, function(x) x %in% names(data))
````


```{r}
# Create interaction terms
#for (year in year_dummies) {
  #data[paste("BlueCollar", year, sep = "_")] <- data$BlueCollar * data[, year]}
````

# First try DiD
```{r}
# summary(lm(dbo_tot_pc~factor(year)*industry+factor(year)+factor(occ)+waterwork_pc+sewage_pc+i_urb_pc, data = data))
````

# Trying to make the data balanced to maybe solve the error of "duplicate couples"

```{r}
#balanced_data <- make.pbalanced(data, index = c("id_occ", "year")) # district by occupation
````

```{r}
# summary(plm(dbo_tot_pc~factor(year)*industry+factor(year)+factor(occ)+waterwork_pc+sewage_pc+i_urb_pc, data = data))

dbo_tot_pc_did <- plm(dbo_tot_pc ~ industry*factor(year, exclude = 1884) + factor(year) + factor(occ) + i_urb_pc + waterwork_pc + sewage_pc,
                    data = data_BHI,
                    index = c("id_occ", "id_year"), # a character vector of length two containing the names of the individual and the time index
                    model = "within", # or "pooling" or "random" or "fd" or "between"
                    effect = "twoways"
                  )

summary(dbo_tot_pc_did)

# print summary using robust standard errors
#coeftest(dbo_tot_pc_did, vcov. = vcovHC, type = "HC1")
````

```{r}
fixef(dbo_tot_pc_did)
 ````

# test 
```{r}
any(table(data$industry, data$year) > 1)
````

# Second try DiD
```{r}
# Convert to panel data
pdata <- pdata.frame(data, index = c("occ", "RB", "year"))

# Model with fixed effects
model <- plm(dbo_tot_pc ~ factor(year)*industry+occ*industry+waterwork_pc*industry+sewage_pc*industry+i_urb_pc*industry, data = pdata, 
             model = "within", effect = "twoways")

summary(model)
````


# Plot timeseries dbo_tot_pc and year
```{r}

````


```{r}
deathrate_year_means <- aggregate(dbo_tot_pc~year, data = data, FUN = mean)

plot(deathrate_year_means)
```

```{r}
library(ggplot2)

# Calculate the mean dbo_tot_pc per year
mean_dbo_tot_pc <- aggregate(dbo_tot_pc ~ year, data = data, FUN = mean)

# Create a scatter plot with the mean dbo_tot_pc per year
ggplot(mean_dbo_tot_pc, aes(x = year, y = dbo_tot_pc)) +
  geom_point() +
  labs(title = "Time Series Plot of Mean dbo_tot_pc",
       x = "Year",
       y = "Mean dbo_tot_pc") +
  theme_minimal()

```

```{r}
library(ggplot2)

# Calculate the mean dbo_tot_pc per year and industry
mean_dbo_tot_pc <- aggregate(dbo_tot_pc ~ year + industry, data = data, FUN = mean)

# Create a scatter plot with different colors for each industry level
ggplot(mean_dbo_tot_pc, aes(x = year, y = dbo_tot_pc, color = factor(industry))) +
  geom_point() +
  labs(title = "Time Series Plot of Mean dbo_tot_pc by Industry",
       x = "Year",
       y = "Mean dbo_tot_pc",
       color = "Industry") +
  theme_minimal()
````

```{r}
library(ggplot2)

# Calculate the mean dbo_tot_pc per year and industry
mean_dbo_tot_pc <- aggregate(dbo_tot_pc ~ year + industry, data = data, FUN = mean)

# Create a scatter plot with different colors for each industry level
ggplot(mean_dbo_tot_pc, aes(x = year, y = dbo_tot_pc, color = factor(industry))) +
  geom_point() +
  geom_line(aes(group = industry), linetype = "dashed") +
  labs(title = "Time Series Plot of Mean dbo_tot_pc by Industry",
       x = "Year",
       y = "Mean dbo_tot_pc",
       color = "Industry") +
  theme_minimal()

````

```{r}
library(ggplot2)

# Calculate the mean dbo_tot_pc per year and industry
mean_dbo_tot_pc <- aggregate(dbo_tot_pc ~ year + industry, data = data, FUN = mean)

# Create a scatter plot with different colors for each industry level
ggplot(mean_dbo_tot_pc, aes(x = year, y = dbo_tot_pc, color = factor(industry))) +
  geom_point() +
  geom_line(aes(group = industry), linetype = "dashed") +
  ggeom_vline(xintercept = 1884, linetype = "dashed", color = "black") +
  labs(title = "Time Series Plot of Mean dbo_tot_pc by Industry",
       x = "Year",
       y = "Mean dbo_tot_pc",
       color = "Industry") +
  theme_minimal()
````

```{r}
library(ggplot2)

# Calculate the mean dbo_tot_pc per year and industry
mean_dbo_tot_pc <- aggregate(dbo_tot_pc ~ year + industry, data = data, FUN = mean)

# Convert the year variable to numeric
mean_dbo_tot_pc$year <- as.numeric(as.character(mean_dbo_tot_pc$year))

# Create a scatter plot with different colors for each industry level
ggplot(mean_dbo_tot_pc, aes(x = year, y = dbo_tot_pc, color = factor(industry))) +
  geom_point() +
  geom_line(aes(group = industry), linetype = "dashed") +
  geom_vline(xintercept = 1884, linetype = "dashed", color = "black", size = 0.5) +
  labs(title = "Development of Mean Death Rate by Industry",
       x = "Year",
       y = "Mean Death Rate",
       color = "Industry") +
  theme_minimal()
```

```{r}
library(ggplot2)

# Calculate the mean dbo_tot_pc per year and industry
mean_dbo_tot_pc <- aggregate(dbo_tot_pc ~ year + industry, data = data, FUN = mean)

# Convert the year variable to numeric
mean_dbo_tot_pc$year <- as.numeric(as.character(mean_dbo_tot_pc$year))

# Create a scatter plot with different colors for each industry level
plot <- ggplot(mean_dbo_tot_pc, aes(x = year, y = dbo_tot_pc, color = factor(industry))) +
  geom_point() +
  geom_line(aes(group = industry), linetype = "dashed") +
  geom_vline(xintercept = 1884, linetype = "dashed", color = "black", size = 1.5) +
  labs(title = "Development of Mean Death Rate by Industry",
       x = "Year",
       y = "Mean dbo_tot_pc") +
  scale_color_manual(values = c("blue", "black"),
                     labels = c("Blue Collar", "Public Servant")) +
  theme_minimal()

# Save the plot as a PNG file
ggsave("plot.png", plot, width = 8, height = 6, dpi = 300)

```